# BadUSB Security Training Lab Environment
# Docker Compose Configuration
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose down           # Stop all services
#   docker-compose logs -f        # View logs
#
# Services:
#   - attacker: Kali-based attack platform
#   - target-linux: Ubuntu target for testing
#   - siem: Wazuh SIEM for log analysis
#   - c2-server: Simple C2 simulation server
#   - web-server: Payload hosting

version: '3.8'

networks:
  lab_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

services:
  # ============================================
  # ATTACKER MACHINE
  # Kali-based attack platform
  # ============================================
  attacker:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile.attacker
    container_name: badusb_attacker
    hostname: attacker
    networks:
      lab_network:
        ipv4_address: 172.20.0.10
    volumes:
      - ./payloads:/root/payloads:ro
      - ./tools:/root/tools
      - ./loot:/root/loot
    ports:
      - "2222:22"      # SSH access
      - "4444:4444"    # Reverse shell listener
      - "8080:8080"    # HTTP server
    environment:
      - TERM=xterm-256color
    cap_add:
      - NET_ADMIN
    tty: true
    stdin_open: true

  # ============================================
  # TARGET LINUX MACHINE
  # Ubuntu-based target for payload testing
  # ============================================
  target-linux:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile.target-linux
    container_name: badusb_target_linux
    hostname: target-linux
    networks:
      lab_network:
        ipv4_address: 172.20.0.20
    volumes:
      - ./evidence:/tmp/evidence
    ports:
      - "2223:22"      # SSH access
    environment:
      - TERM=xterm-256color
    tty: true
    stdin_open: true

  # ============================================
  # SIEM / LOG ANALYSIS
  # Wazuh for security monitoring
  # ============================================
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.0
    container_name: badusb_siem
    hostname: wazuh-manager
    networks:
      lab_network:
        ipv4_address: 172.20.0.30
    ports:
      - "1514:1514/udp"  # Agent connection
      - "1515:1515"      # Agent enrollment
      - "55000:55000"    # API
    volumes:
      - wazuh_data:/var/ossec/data
      - ./siem/rules:/var/ossec/etc/rules/local_rules.xml:ro
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword

  # ============================================
  # C2 SIMULATION SERVER
  # Simple beacon receiver for testing
  # ============================================
  c2-server:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile.c2
    container_name: badusb_c2
    hostname: c2-server
    networks:
      lab_network:
        ipv4_address: 172.20.0.40
    ports:
      - "8888:8888"    # C2 listener
      - "53:53/udp"    # DNS (for DNS tunneling tests)
    volumes:
      - ./loot:/app/loot
    environment:
      - C2_PORT=8888

  # ============================================
  # WEB SERVER
  # Payload and file hosting
  # ============================================
  web-server:
    image: nginx:alpine
    container_name: badusb_web
    hostname: web-server
    networks:
      lab_network:
        ipv4_address: 172.20.0.50
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./payloads:/usr/share/nginx/html:ro
      - ./dockerfiles/nginx.conf:/etc/nginx/nginx.conf:ro

  # ============================================
  # DNS SERVER
  # For DNS exfiltration testing
  # ============================================
  dns-server:
    image: coredns/coredns:latest
    container_name: badusb_dns
    hostname: dns-server
    networks:
      lab_network:
        ipv4_address: 172.20.0.60
    ports:
      - "5353:53/udp"
    volumes:
      - ./dockerfiles/Corefile:/Corefile:ro
    command: -conf /Corefile

volumes:
  wazuh_data:
